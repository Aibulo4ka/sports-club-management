"""
AI Персональный тренер для спортивного клуба
Использует Google Gemini через Agno framework
"""
import os
from decouple import config
from agno.agent import Agent
from agno.models.google import Gemini


def get_gemini_api_key():
    """
    Получить API ключ Gemini из переменных окружения
    """
    api_key = config('GEMINI_API_KEY', default='')
    # Agno также ищет GOOGLE_API_KEY, установим его для совместимости
    if api_key and not os.getenv('GOOGLE_API_KEY'):
        os.environ['GOOGLE_API_KEY'] = api_key
    return api_key


def create_fitness_agent():
    """
    Создать AI агента-тренера для фитнеса
    """
    gemini_model = Gemini(id="gemini-flash-latest", api_key=get_gemini_api_key())

    agent = Agent(
        name="Фитнес Тренер",
        role="Персональный тренер по фитнесу",
        model=gemini_model,
        instructions=[
            "Ты - профессиональный персональный тренер в спортивном клубе АС УСК.",
            "Твоя задача - создавать индивидуальные программы тренировок на основе данных клиента.",
            "Учитывай возраст, уровень подготовки, цели и тип абонемента клиента.",
            "Предоставляй детальные программы с упражнениями, подходами и повторениями.",
            "Структурируй тренировку: разминка (10 мин) → основная часть (40-50 мин) → заминка (10 мин).",
            "Объясняй технику выполнения упражнений и предупреждай о возможных ошибках.",
            "Давай советы по восстановлению и прогрессии нагрузок.",
            "Будь мотивирующим, но реалистичным в своих рекомендациях.",
            "Отвечай на русском языке."
        ],
        markdown=True,
    )

    return agent


def create_nutrition_agent():
    """
    Создать AI агента-диетолога
    """
    gemini_model = Gemini(id="gemini-flash-latest", api_key=get_gemini_api_key())

    agent = Agent(
        name="Диетолог",
        role="Специалист по спортивному питанию",
        model=gemini_model,
        instructions=[
            "Ты - профессиональный диетолог, специализирующийся на спортивном питании.",
            "Твоя задача - создавать планы питания для клиентов спортивного клуба.",
            "Учитывай цели клиента (похудение, набор массы, поддержание формы).",
            "Предоставляй конкретные рекомендации по калорийности и макронутриентам.",
            "Создавай примерное меню на день с указанием времени приёма пищи.",
            "Давай советы по гидратации и приёму пищи до/после тренировок.",
            "Учитывай особенности питания для разных типов тренировок (силовые, кардио, йога).",
            "Будь практичным - предлагай доступные и простые в приготовлении блюда.",
            "Отвечай на русском языке."
        ],
        markdown=True,
    )

    return agent


def generate_workout_plan(client_data):
    """
    Генерация программы тренировок на основе данных клиента

    Args:
        client_data (dict): Данные клиента (возраст, цель, уровень подготовки, тип абонемента)

    Returns:
        str: Сгенерированная программа тренировок
    """
    agent = create_fitness_agent()

    prompt = f"""
Создай персональную программу тренировок для клиента со следующими параметрами:

**Данные клиента:**
- Возраст: {client_data.get('age', 'не указан')} лет
- Пол: {client_data.get('sex', 'не указан')}
- Уровень подготовки: {client_data.get('fitness_level', 'начальный')}
- Цель: {client_data.get('goal', 'общая физическая подготовка')}
- Тип абонемента: {client_data.get('membership_type', 'не указан')}
- Дополнительная информация: {client_data.get('additional_info', 'нет')}

**Требования к программе:**
1. Программа должна быть рассчитана на неделю (указать количество тренировок)
2. Каждая тренировка должна включать: разминку, основную часть, заминку
3. Для каждого упражнения указать: название, подходы, повторения, отдых между подходами
4. Добавить советы по технике безопасности
5. Дать рекомендации по прогрессии нагрузок

Создай детальную и мотивирующую программу!
"""

    try:
        response = agent.run(prompt)
        return response.content
    except Exception as e:
        return f"Ошибка при генерации программы: {str(e)}"


def generate_nutrition_plan(client_data):
    """
    Генерация плана питания на основе данных клиента

    Args:
        client_data (dict): Данные клиента (возраст, цель, уровень активности)

    Returns:
        str: Сгенерированный план питания
    """
    agent = create_nutrition_agent()

    prompt = f"""
Создай план питания для клиента со следующими параметрами:

**Данные клиента:**
- Возраст: {client_data.get('age', 'не указан')} лет
- Пол: {client_data.get('sex', 'не указан')}
- Цель: {client_data.get('goal', 'поддержание формы')}
- Уровень активности: {client_data.get('activity_level', 'средний')}
- Диетические предпочтения: {client_data.get('dietary_preferences', 'нет')}

**Требования к плану:**
1. Рассчитать примерную суточную калорийность
2. Распределить макронутриенты (белки, жиры, углеводы)
3. Создать примерное меню на день (5-6 приёмов пищи)
4. Дать рекомендации по питанию до и после тренировок
5. Советы по гидратации

Создай практичный и понятный план питания!
"""

    try:
        response = agent.run(prompt)
        return response.content
    except Exception as e:
        return f"Ошибка при генерации плана питания: {str(e)}"


def answer_fitness_question(question, context=None):
    """
    Ответить на вопрос клиента о фитнесе

    Args:
        question (str): Вопрос клиента
        context (str, optional): Контекст (например, предыдущая программа)

    Returns:
        str: Ответ на вопрос
    """
    agent = create_fitness_agent()

    if context:
        prompt = f"""
Контекст: {context}

Вопрос клиента: {question}

Дай детальный и профессиональный ответ.
"""
    else:
        prompt = question

    try:
        response = agent.run(prompt)
        return response.content
    except Exception as e:
        return f"Ошибка при ответе на вопрос: {str(e)}"
