# План реализации проекта АС УСК
## Автоматизированная система управления спортивным клубом

---

## Технологический стек

### Backend
- **Python 3.11+**
- **Django 4.2+** - основной веб-фреймворк
- **Django REST Framework** - API
- **PostgreSQL 15+** - основная база данных (11 сущностей)
- **Redis 7+** - кеширование, сессии
- **Celery** - асинхронные задачи (email, напоминания)
- **Docker + Docker Compose** - контейнеризация

### Frontend
- **Django Templates** - серверный рендеринг
- **Bootstrap 5** - UI framework
- **JavaScript (Vanilla/jQuery)** - интерактивность
- **HTMX** - динамические обновления (опционально)

### Внешние интеграции
- **ЮKassa/Stripe API** - платежная система
- **SMTP** - email уведомления
- **1С:Бухгалтерия API** - экспорт финансовых данных

### DevOps
- **Git** - контроль версий
- **pytest** - тестирование (цель: 60%+ coverage)
- **GitHub Actions** - CI/CD (опционально)

---

## Модель данных (из ЛР6)

### Основные сущности (11 таблиц):

1. **Client** - клиенты клуба
2. **Trainer** - тренеры
3. **Admin** - администраторы системы
4. **MembershipType** - типы абонементов (месячный, годовой, безлимит)
5. **Membership** - купленные абонементы клиентов
6. **ClassType** - типы занятий (йога, фитнес, бокс, плавание)
7. **Class** - конкретные занятия в расписании
8. **Room** - залы/помещения
9. **Schedule** - расписание занятий
10. **Booking** - бронирования клиентов
11. **Visit** - фактические посещения
12. **Payment** - платежи

---

## Детальный план по спринтам (3 месяца)

### Спринт 1 (Недели 1-2): Инфраструктура и фундамент
**Цель:** Настроить окружение, базовую авторизацию, модель данных

#### Backend задачи:
- [ ] Инициализация Django проекта
  - `django-admin startproject config .`
  - Создание виртуального окружения
  - requirements.txt с зависимостями

- [ ] Настройка баз данных
  - PostgreSQL: подключение, settings.py
  - Redis: настройка для кеша и сессий

- [ ] Docker конфигурация
  - Dockerfile для backend
  - docker-compose.yml (postgres, redis, backend)
  - .env файл с секретами

- [ ] Создание Django приложений
  ```bash
  python manage.py startapp accounts
  python manage.py startapp memberships
  python manage.py startapp classes
  python manage.py startapp bookings
  python manage.py startapp payments
  python manage.py startapp facilities
  python manage.py startapp analytics
  ```

- [ ] Django Models для всех 11 сущностей (из ЛР6)
  - `accounts/models.py`: Client, Trainer (extend User)
  - `memberships/models.py`: MembershipType, Membership
  - `classes/models.py`: ClassType, Class
  - `facilities/models.py`: Room
  - `bookings/models.py`: Booking, Visit, Schedule
  - `payments/models.py`: Payment

- [ ] Миграции базы данных
  ```bash
  python manage.py makemigrations
  python manage.py migrate
  ```

- [ ] Базовая аутентификация
  - Django Auth (User model)
  - Регистрация клиентов
  - Вход/выход (login/logout views)
  - Разделение ролей (Client/Trainer/Admin)

- [ ] Настройка Django Admin панели
  - Регистрация всех моделей
  - Кастомизация админки (list_display, filters)
  - Создание суперпользователя

#### Frontend задачи:
- [ ] Базовая структура templates
  - `templates/base.html` - базовый шаблон
  - `templates/navbar.html` - навигация
  - `templates/footer.html`

- [ ] Главная страница (landing)
  - Описание клуба
  - Преимущества
  - CTA кнопки (регистрация, вход)

- [ ] Страницы аутентификации
  - `templates/accounts/login.html`
  - `templates/accounts/register.html`
  - `templates/accounts/profile.html`

- [ ] Bootstrap 5 интеграция
  - Подключение CSS/JS
  - Базовая стилизация
  - Адаптивная navbar

#### Результат спринта 1:
✅ Работающее Docker окружение
✅ Все модели данных созданы
✅ Вход/регистрация работает
✅ Админ-панель настроена
✅ Базовая навигация по сайту

---

### Спринт 2 (Недели 3-4): CRM и Абонементы
**Цель:** Управление клиентами и базовое управление абонементами

#### Backend задачи:
- [ ] CRUD API для клиентов
  - ViewSets для Client model (DRF)
  - Сериализаторы (ClientSerializer)
  - URL routing
  - Permissions (IsAuthenticated, IsAdmin)

- [ ] Модуль управления абонементами
  - CRUD для MembershipType (админ)
  - CRUD для Membership (клиенты)
  - Бизнес-логика:
    * Валидация дат (StartDate < EndDate)
    * Автоматический расчет EndDate по типу
    * Проверка перекрытия абонементов

- [ ] Паттерн Strategy для скидок (из Lr3/Strategy.py)
  - `core/patterns/strategy.py`:
    * Абстрактный класс DiscountStrategy
    * StudentDiscount (20%)
    * GroupDiscount (15% для групп 3+)
    * LoyaltyDiscount (10% для клиентов >1 года)
  - Интеграция в PriceCalculator

- [ ] REST API endpoints
  ```
  GET  /api/clients/               # Список клиентов
  POST /api/clients/               # Добавить клиента
  GET  /api/clients/{id}/          # Детали клиента
  PUT  /api/clients/{id}/          # Обновить клиента
  DELETE /api/clients/{id}/        # Удалить клиента

  GET  /api/memberships/           # Список абонементов
  POST /api/memberships/purchase/  # Купить абонемент
  GET  /api/memberships/my/        # Мои абонементы
  ```

#### Frontend задачи:
- [ ] Страница списка клиентов (для админа)
  - Таблица с клиентами
  - Поиск по имени/email/телефону
  - Фильтры (активные/неактивные)
  - Пагинация

- [ ] Форма добавления/редактирования клиента
  - Валидация полей (email, phone)
  - Ajax отправка формы
  - Обработка ошибок

- [ ] Каталог абонементов
  - `templates/memberships/catalog.html`
  - Карточки типов абонементов (цена, длительность)
  - Отображение скидок
  - Кнопка "Купить"

- [ ] Форма покупки абонемента
  - Выбор типа абонемента
  - Применение скидки (студенческая, групповая)
  - Подтверждение покупки

- [ ] Профиль клиента
  - Личные данные (редактирование)
  - Список моих абонементов (активные/истекшие)
  - Статус абонемента (дней осталось)

#### Результат спринта 2:
✅ Полная CRM система для клиентов
✅ Каталог типов абонементов
✅ Система скидок работает
✅ Клиенты могут покупать абонементы (без онлайн-оплаты пока)
✅ Админ может управлять клиентами

---

### Спринт 3 (Недели 5-6): Расписание занятий
**Цель:** Создание и просмотр расписания тренировок

#### Backend задачи:
- [ ] CRUD API для занятий
  - ViewSets для Class, ClassType, Room
  - Сериализаторы с вложенными данными
  - Permissions (только админы создают занятия)

- [ ] Schedule API с фильтрами
  ```
  GET /api/classes/                    # Все занятия
  GET /api/classes/?date=2025-11-01    # По дате
  GET /api/classes/?trainer_id=5       # По тренеру
  GET /api/classes/?type=yoga          # По типу
  GET /api/classes/?week=2025-W44      # Неделя
  ```

- [ ] Бизнес-логика расписания
  - Проверка пересечений:
    * Один тренер не может вести 2 занятия одновременно
    * Один зал не может использоваться дважды одновременно
  - Валидация времени (DateTime + Duration)
  - Расчет доступных мест (CurrentCapacity / MaxCapacity)

- [ ] Управление тренерами
  - CRUD API для Trainer model
  - Профили тренеров (специализация, опыт)
  - Расписание тренера (календарь его занятий)

- [ ] Управление залами
  - CRUD API для Room model
  - Характеристики (площадь, оборудование)

- [ ] Паттерн Factory для создания занятий
  - `core/patterns/factory.py`:
    * ClassFactory.create_class(type, trainer, room, datetime)
    * Разные настройки по умолчанию для типов (йога: 60 мин, фитнес: 90 мин)

#### Frontend задачи:
- [ ] Календарное представление расписания
  - Week view (понедельник-воскресенье)
  - Day view (список занятий на день)
  - Month view (мини-календарь)
  - Библиотека: FullCalendar.js или custom

- [ ] Фильтры расписания
  - Выбор даты (date picker)
  - Фильтр по тренеру (dropdown)
  - Фильтр по типу занятия (yoga, fitness, boxing)
  - Сброс фильтров

- [ ] Форма создания занятия (для админа)
  - Выбор типа занятия
  - Выбор тренера
  - Выбор зала
  - Дата и время (datetime picker)
  - Максимальное количество мест
  - Проверка конфликтов (Ajax)

- [ ] Карточка занятия
  - Название занятия
  - Тренер (фото, имя)
  - Время и длительность
  - Зал
  - Доступные места (X/MaxCapacity)
  - Кнопка "Забронировать" (если есть места)

- [ ] Список тренеров
  - `templates/trainers/list.html`
  - Карточки тренеров (фото, специализация)
  - Ссылка на расписание тренера

#### Результат спринта 3:
✅ Полное расписание занятий с календарем
✅ Админ может создавать/редактировать занятия
✅ Клиенты видят расписание с фильтрами
✅ Проверка конфликтов работает
✅ Отображение свободных мест

---

### Спринт 4 (Недели 7-8): Система бронирования
**Цель:** Бронирование занятий клиентами

#### Backend задачи:
- [ ] Booking API
  ```
  POST /api/bookings/                # Создать бронирование
  GET  /api/bookings/my/             # Мои бронирования
  DELETE /api/bookings/{id}/cancel/  # Отменить бронирование
  GET  /api/bookings/?class_id=123   # Бронирования на занятие
  ```

- [ ] Бизнес-логика бронирования
  - **Проверка наличия мест:**
    * Запрос текущего количества бронирований
    * Сравнение с MaxCapacity
    * Блокировка при достижении лимита

  - **Проверка активного абонемента:**
    * У клиента должен быть активный абонемент
    * EndDate > DateTime занятия
    * Списание посещения из абонемента (если лимитированный)

  - **Защита от дублей:**
    * Клиент не может забронировать одно занятие дважды
    * Constraint на уровне БД (unique_together)

  - **Автоматическая отмена:**
    * Celery task: за 2 часа до занятия проверить статус
    * Если клиент не подтвердил - отменить и освободить место

- [ ] Visit tracking (посещаемость)
  - Отметка фактического прихода (QR-код / админ)
  - Статистика посещаемости клиента
  - No-show tracking (не пришел после брони)

- [ ] Real-time updates
  - **Вариант 1:** Django Channels + WebSocket (сложнее)
  - **Вариант 2:** Polling (каждые 30 сек) (проще для MVP)
  - Обновление счетчика свободных мест

- [ ] Celery задачи
  - `tasks.py`:
    * send_booking_reminder(booking_id) - за 2 часа
    * cancel_unconfirmed_bookings() - за 30 мин
    * send_class_summary_to_trainer(class_id) - после занятия

#### Frontend задачи:
- [ ] Кнопка "Забронировать" на карточках занятий
  - Проверка авторизации (иначе redirect на login)
  - Проверка активного абонемента (иначе показать предупреждение)
  - Ajax POST запрос к API
  - Обработка ошибок (нет мест, уже забронировано)
  - Успешное сообщение (modal или toast)

- [ ] Страница "Мои бронирования"
  - `templates/bookings/my_bookings.html`
  - Вкладки: Предстоящие / Прошедшие
  - Список занятий (дата, время, тренер, зал)
  - Кнопка "Отменить" (если >24 часа до занятия)
  - Статус бронирования (Confirmed, Cancelled, Completed)

- [ ] Индикатор заполненности
  - Progress bar: "Занято 8 из 10 мест"
  - Цвета: зеленый (много мест), желтый (<5), красный (<2)
  - Иконка "Полностью забронировано" (disable кнопку)

- [ ] Модальное окно отмены
  - Подтверждение: "Вы уверены, что хотите отменить?"
  - Причина отмены (опционально)
  - Ajax DELETE запрос

- [ ] Уведомления о статусе
  - Toast уведомления (Bootstrap Toast)
  - "Бронирование успешно создано!"
  - "Бронирование отменено"
  - "Напоминание: через 2 часа ваше занятие"

#### Результат спринта 4:
✅ Работающая система бронирования с лимитами
✅ Клиенты могут бронировать/отменять занятия
✅ Проверка абонементов при бронировании
✅ Отображение свободных мест в реальном времени
✅ Email напоминания за 2 часа до занятия

---

### Спринт 5 (Недели 9-10): Интеграция платежей
**Цель:** Онлайн-покупка абонементов с оплатой картой

#### Backend задачи:
- [ ] Payment model (из ЛР6)
  - Поля: PaymentID, ClientID, Amount, Status, PaymentMethod, TransactionID
  - Статусы: Pending, Completed, Failed, Refunded

- [ ] Интеграция платежной системы
  - **Выбор:** ЮKassa (для России) или Stripe (международный)
  - Установка SDK: `pip install yookassa`
  - Настройка API ключей (в .env)

- [ ] Payment flow
  ```
  1. Клиент выбирает абонемент -> POST /api/payments/create/
  2. Backend создает Payment (status=Pending)
  3. Backend делает запрос в ЮKassa -> получает payment_url
  4. Redirect клиента на payment_url
  5. Клиент оплачивает на стороне ЮKassa
  6. ЮKassa отправляет webhook на /api/payments/webhook/
  7. Backend обновляет Payment (status=Completed)
  8. Backend активирует Membership
  9. Backend отправляет email с чеком
  ```

- [ ] Webhook обработка
  - `payments/views.py`: webhook_handler(request)
  - Проверка подписи (security)
  - Парсинг данных от ЮKassa
  - Обновление статуса Payment
  - Идемпотентность (защита от дублей)

- [ ] Автоматическая активация абонемента
  - При status=Completed:
    * Создать Membership (или обновить существующий)
    * Установить StartDate = today, EndDate = today + duration
    * Отправить email подтверждение

- [ ] Паттерн Observer для уведомлений (из Lr3)
  - `core/patterns/observer.py`:
    * Subject: Payment
    * Observers: EmailNotifier, SMSNotifier (опционально), AnalyticsLogger
  - При изменении статуса Payment -> notify всех observers

- [ ] Email уведомления
  - Django + SMTP (Gmail или SendGrid)
  - Шаблоны писем:
    * payment_success.html (чек)
    * membership_activated.html
    * booking_reminder.html
  - Celery task: send_email_async(to, subject, template, context)

- [ ] История платежей
  - API endpoint: GET /api/payments/my/
  - Фильтры по дате, статусу
  - Экспорт в PDF (опционально)

#### Frontend задачи:
- [ ] Страница выбора абонемента (catalog)
  - `templates/memberships/catalog.html`
  - Карточки с типами абонементов:
    * Название (Месячный, Годовой, Безлимит)
    * Цена (со скидкой если есть)
    * Описание (количество занятий, длительность)
    * Кнопка "Выбрать"
  - Применение скидок (показать старую цену зачеркнутой)

- [ ] Корзина (cart)
  - Может быть простой: один абонемент за раз
  - Подтверждение выбора
  - Итоговая сумма с расшифровкой (база + скидка = итого)
  - Кнопка "Перейти к оплате"

- [ ] Форма оплаты
  - Вариант 1: Redirect на виджет ЮKassa
  - Вариант 2: Встроенный iframe виджет
  - Показать безопасность платежа (иконки, SSL)

- [ ] Страница успешной оплаты
  - `templates/payments/success.html`
  - Благодарность за покупку
  - Детали заказа (номер чека, дата, сумма)
  - Ссылка на "Мои абонементы"
  - Ссылка на "Расписание занятий"

- [ ] История покупок в профиле
  - `templates/accounts/payment_history.html`
  - Таблица платежей (дата, абонемент, сумма, статус)
  - Ссылка на скачивание чека (PDF)

#### Результат спринта 5:
✅ Полный цикл онлайн-покупки абонементов
✅ Интеграция с платежной системой (ЮKassa/Stripe)
✅ Автоматическая активация абонемента после оплаты
✅ Email уведомления (чек, подтверждение)
✅ История платежей

---

### Спринт 6 (Недели 11-12): Аналитика, тесты, релиз
**Цель:** Dashboard админа, исправление багов, подготовка к релизу

#### Backend задачи:
- [ ] Analytics API (dashboard для админа)
  ```
  GET /api/analytics/clients_count/        # Количество клиентов (всего, новых за месяц)
  GET /api/analytics/revenue/              # Выручка (по дням, неделям, месяцам)
  GET /api/analytics/popular_classes/      # Топ-5 популярных занятий
  GET /api/analytics/trainer_load/         # Загрузка тренеров (часов в неделю)
  GET /api/analytics/membership_types/     # Распределение по типам абонементов
  GET /api/analytics/attendance_rate/      # Процент посещаемости (visits/bookings)
  ```

- [ ] Реализация аналитики
  - Django ORM aggregations (Count, Sum, Avg)
  - Оптимизация запросов (select_related, prefetch_related)
  - Кеширование результатов в Redis (на 5 минут)
  - Использование Singleton CacheManager (из Lr3)

- [ ] Экспорт в 1С (из Context.html)
  - API endpoint: GET /api/export/1c/
  - Формат: XML или JSON (по стандарту 1С)
  - Данные: платежи за период, клиенты, тренеры (ЗП)
  - Защита: только для админов с правами бухгалтера

- [ ] SMS уведомления (опционально)
  - Интеграция Twilio или SMSC.ru
  - SMS за 2 часа до занятия (альтернатива email)
  - Настройка в профиле клиента (email or sms)

- [ ] Оптимизация запросов
  - Django Debug Toolbar для анализа
  - Устранение N+1 проблем
  - Добавление database indexes (в миграциях)
  - Query optimization (explain analyze)

- [ ] Покрытие тестами (pytest)
  - Unit tests для моделей (validators)
  - Unit tests для паттернов (Strategy, Factory, Observer)
  - Integration tests для API endpoints
  - Fixtures для тестовых данных
  - Цель: минимум 60% coverage

  ```bash
  # Запуск тестов
  pytest --cov=apps --cov-report=html
  ```

#### Frontend задачи:
- [ ] Dashboard для администратора
  - `templates/analytics/dashboard.html`
  - **Виджеты:**
    * Общая статистика (карточки): клиенты, выручка, занятий, загрузка
    * График выручки (Chart.js): по дням за месяц
    * График популярности занятий (bar chart)
    * Таблица топ-тренеров (по количеству занятий)
    * Календарь загрузки (heatmap: цвет = количество бронирований)

- [ ] Конструктор индивидуальных программ (опционально)
  - Админ/тренер может создать персональную программу для клиента
  - Выбор упражнений, подходов, повторений
  - Назначение дней недели
  - Клиент видит свою программу в профиле

- [ ] Улучшение UX/UI
  - Добавить loading spinners (при загрузке данных)
  - Skeleton screens (для карточек)
  - Transitions и animations (плавные переходы)
  - Feedback при действиях (toast уведомления)
  - Empty states (если нет данных)

- [ ] Адаптивная верстка (mobile responsive)
  - Проверка на мобильных (iPhone, Android)
  - Bootstrap breakpoints (xs, sm, md, lg, xl)
  - Mobile menu (burger)
  - Тач-дружелюбные элементы (большие кнопки)

- [ ] Исправление багов
  - Сбор багов из тестирования (bug tracker)
  - Приоритизация (критичные -> мелкие)
  - Систематическое исправление
  - Regression testing

#### QA задачи:
- [ ] Полное тестирование функциональности
  - **Smoke testing:** основные флоу работают
  - **Regression testing:** старые фичи не сломались
  - **User acceptance testing (UAT):** соответствие требованиям

- [ ] Тест-кейсы по модулям:
  - Регистрация/вход
  - Покупка абонемента с оплатой
  - Бронирование занятия
  - Отмена бронирования
  - Создание расписания админом
  - Email уведомления

- [ ] Нагрузочное тестирование (basic)
  - Инструмент: Locust или Apache JMeter
  - Сценарий: 50 одновременных пользователей
  - Метрики: response time, throughput, error rate
  - Цель: <2 сек для 95% запросов

- [ ] Безопасность (security testing)
  - SQL injection (защита через ORM)
  - XSS (защита через Django templates auto-escaping)
  - CSRF (Django middleware)
  - Проверка прав доступа (клиент не может удалить других клиентов)

- [ ] Документация для пользователей
  - User guide (как пользоваться системой)
  - Admin guide (как управлять)
  - FAQ
  - Screenshots с пояснениями

#### DevOps задачи:
- [ ] Подготовка к деплою
  - Настройка production settings (DEBUG=False, ALLOWED_HOSTS)
  - Сбор статики (collectstatic)
  - Миграции на production БД
  - Environment variables (.env)

- [ ] Docker production build
  - Multi-stage Dockerfile (оптимизация размера)
  - docker-compose.prod.yml
  - Nginx как reverse proxy (опционально)

- [ ] Backup стратегия
  - PostgreSQL dump (pg_dump)
  - Автоматический backup раз в день
  - Хранение в S3 или локально

#### Результат спринта 6:
✅ Dashboard с аналитикой для админа
✅ Экспорт данных в 1С
✅ Покрытие тестами >60%
✅ Все баги исправлены
✅ Production-ready приложение
✅ Документация готова

---

## Критерии готовности (Definition of Done)

Для каждого спринта:
- ✅ Все задачи выполнены
- ✅ Code review пройден
- ✅ Unit тесты написаны и проходят
- ✅ Функциональность протестирована QA
- ✅ Документация обновлена
- ✅ Нет критичных багов

Для релиза (конец спринта 6):
- ✅ Все спринты завершены
- ✅ Приложение задеплоено и работает
- ✅ User guide и admin guide готовы
- ✅ Презентация для защиты подготовлена

---

## Оценка трудозатрат (из ЛР1)

- **Общая оценка:** 55 Function Points = 440 person-hours
- **Команда:** 3 человека (Backend, Frontend, QA)
- **Длительность:** 12 недель (3 месяца)
- **Часов на человека:** ~147 часов (18-19 часов/неделю)

**Распределение по спринтам:**
- Спринт 1: 90 часов (основа)
- Спринт 2: 80 часов (CRM)
- Спринт 3: 80 часов (расписание)
- Спринт 4: 70 часов (бронирование)
- Спринт 5: 70 часов (платежи)
- Спринт 6: 50 часов (аналитика + баги)

---

## Риски и митигации

### Риск 1: Интеграция с платежной системой сложнее ожидаемого
**Митигация:** Выделить дополнительное время в спринте 5, использовать sandbox для тестирования

### Риск 2: Проблемы с производительностью при большом количестве бронирований
**Митигация:** Кеширование (Redis), оптимизация запросов, индексы в БД

### Риск 3: Задержки в одном из спринтов
**Митигация:** Buffertime в спринте 6 для доработок, приоритизация критичных функций

### Риск 4: Нехватка знаний по Django/DRF
**Митигация:** Обучение в первом спринте, использование документации, code review

---

## Полезные ресурсы

### Документация:
- Django: https://docs.djangoproject.com/
- Django REST Framework: https://www.django-rest-framework.org/
- PostgreSQL: https://www.postgresql.org/docs/
- Redis: https://redis.io/documentation
- ЮKassa API: https://yookassa.ru/developers

### Обучение:
- Django for Beginners (книга)
- DRF Tutorial (официальный)
- Real Python (Django tutorials)

---

**Дата создания:** 2025-10-29
**Автор:** Команда разработки АС УСК
**Версия:** 1.0
